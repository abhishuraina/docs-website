---
title: "Agent Control migration guide"
metaDescription: "You can reinstall your current instrumentation to manage it through Agent Control"
freshnessValidatedDate: never
---
<Callout title="preview">
  We're still working on this feature, but we'd love for you to try it out!

  This feature is currently provided as part of a preview program pursuant to our [pre-release policies](/docs/licenses/license-information/referenced-policies/new-relic-pre-release-policy).
</Callout>

## Migrate the instrumentation to manage it with Agent Control
If you have a cluster already instrumented with NewRelic you can decide to remove the existing agents and manage them through the Agent Control.
All features and all configs exposed by the HelmChart of each Agent can still be applied in a unified way through the Agent Control.

### Match the existing instrumentation with the new Agents managed by the AgentControl
First of all you need to match your existing instrumentation with the supported agents.

In particular you can deploy and manage through the Agent Control:
  - Most of the Helm Charts included in the `nri-bundle` chart: 
    - `newrelic-infrastructure`, `nri-kube-events`, `kube-state-metrics`, and `nri-kube-events` now managed through the New Relic Infrastructure AgentType.
    - `newrelic-prometheus-configurator` now managed through the New Relic Prometheus AgentType
    - `newrelic-logging` now managed through the Fluent Bit AgentType
  - And the chart `nr-k8s-otel-collector` now managed through the New Relic OpenTelemetry Collector AgentType 

If you have installed the agents leveraging Helm you need to retrieve the `values.yaml` used during the installation. 
If you have it stored no action is needed, otherwise you can retrive it from the cluster.
You can retrieve the values running the following command:
```sh
$ helm get values <release-name> --namespace <namespace-name>
```

On the other hand, if you have instrumented the cluster via manifest you need to find in the corresponding options in each Agent Chart. 

<Callout title="TIP">
    You can keep in the cluster any agent or component, in particular the ones not supported yet by the Agent Control. 
    To assure the best experience make sure to keep the same clusterName and point to the same account.
</Callout>


### Create the `values.yaml` config to install the Agent Control
Start the [Agent Control Installation](/docs/new-relic-control/agent-control/setup/) via Guided install and select all the agents you are interested in.
Copy locally the `values.yaml`, and before applying it change each Agent config to match the one of the Agents already running in the cluster.

### Disinstall the agents you want to migrate

Uninstall the agents and components that you want to migrate and manage via Agent Control.
Refer to your existing agent documentation for instructions on how to uninstall them.

### Helm Installation
Once you have modified your `values.yaml` file you can continue with the installation steps included in the flow of the guided install.


### Example

We had a cluster already instrumented via Helm Charts. 
We have retrieved the following `values.yaml` from a release of `nri-bunle`:
```
global:
  cluster: test-migration
  licenseKey: ***
kube-state-metrics:
  enabled: false
newrelic-prometheus-agent:
  enabled: true
newrelic-infrastructure:
  enabled: true
  kubelet:
    tolerations:
      - operator: "Exists"
        effect: "NoSchedule"
      - operator: "Exists"
        effect: "NoExecute"
      - operator: "Exists"
        key: "MyToleration"
  ksm:
    enabled: false
  common:
    config:
      interval: 29s
newrelic-logging:
  enabled: true
  image:
    tag: "latest"
  resources:
    limits:
      cpu: 200m
    requests:
      cpu: 200m
nri-kube-events:
  enabled: true
  customAttributes: 
    test_tag_label: test_tag_value
```
Notice that `nri-kube-events`, `newrelic-logging` and `newrelic-infrastructure` have a configuration that needs to be migrated.
On the other hand, `newrelic-prometheus-agent` was installed as part of `nri-bundle` and had no additional configuration
Moreover, we had the KSM component disabled.

You can retrieve a configuration created throught the Guided install and modify the `values.yaml` file to make sure you enable all the agents you are migrating and you are keeping the same configuration.
```
global:
  cluster: "test-migration"
  licenseKey: "****"
agent-control-deployment:
  identityClientId: "****"
  identityClientSecret: "****"
  config:
    fleet_control:
      fleet_id: "****"
      auth:
        organizationId: "****"
    subAgents:
      logs:
        type: newrelic/io.fluentbit:0.1.0
        content:
          chart_version: "1.25.1"
          chart_values:
            newrelic-logging:
                image:
                  tag: "latest"
                resources:
                  limits:
                    cpu: 200m
                  requests:
                    cpu: 200m
      infrastructure:
        type: newrelic/com.newrelic.infrastructure:0.1.0
        content:
          chart_version: "5.0.109"
          chart_values:
            newrelic-infrastructure:
              kubelet:
                tolerations:
                  - operator: "Exists"
                    effect: "NoSchedule"
                  - operator: "Exists"
                    effect: "NoExecute"
                  - operator: "Exists"
                    key: "MyToleration"
              ksm:
                enabled: false
              common:
                config:
                  interval: 29s
            nri-kube-events:
              customAttributes: 
                test_tag_label: test_tag_value
            kube-state-metrics:
              enabled: false
      prometheus:
        type: newrelic/com.newrelic.prometheus:0.1.0
        content:
          chart_version: "1.15.4"
```

Now we can delete the old instrumentation:
```sh
helm delete my-installation -n newrelic
```

And create the new one via AgentControl:
```
helm upgrade --install agent-control -n newrelic newrelic/agent-control --create-namespace --values my_migrated_values.yaml
```
